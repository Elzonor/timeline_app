<%= form_with(model: [@timeline, event], local: true, html: { class: 'events-form' }) do |form| %>
  <% if event.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(event.errors.count, "error") %> prohibited this event from being saved:</h2>

      <ul>
      <% event.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>
  
  <div id="event-description" class="form-data-block">

    <div class="field">
      <%= form.label :name, t('labels.name') %>
      <%= form.text_field :name, autocomplete: "off" %>
    </div>

    <div class="field">
      <%= form.label :description, t('labels.description') %>
      <%= form.text_area :description %>
    </div>

  </div>

  <div id="event-duration" class="form-data-block">
    <%# Campo nascosto per mantenere retrocompatibilità %>
    <%= hidden_field_tag :current_duration_type, event.event_duration %>

    <div class="field duration-type">
      <div class="duration-option">
        <%= radio_button_tag :duration_type, '1-day', event.event_duration == '1-day' || event.new_record?, 
            class: 'duration-radio', id: 'duration_type_single' %>
        <label for="duration_type_single"><%= t('labels.duration.one_day') %></label>
        <div class="date-container single-day-container">
          <%# Contenitore dei campi data - mostrato qui se è un evento di un giorno %>
          <% if event.event_duration == '1-day' || event.new_record? %>
            <div id="date-fields-container" class="date-range-fields" style="display: flex;">
              <div class="date-field">
                <label><%= t('labels.duration.from') %></label>
                <%= form.date_field :start_date, class: 'multi-day-start date-field', placeholder: 'Choose date...', 
                    data: { controller: 'datepicker' } %>
              </div>
              <div class="date-field">
                <label><%= t('labels.duration.to') %></label>
                <%= form.date_field :end_date, class: 'multi-day-end date-field', placeholder: 'Choose date...', 
                    data: { controller: 'datepicker' } %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <div class="duration-option">
        <%= radio_button_tag :duration_type, 'multi-day', event.event_duration == 'multi-day',
            class: 'duration-radio', id: 'duration_type_multi' %>
        <label for="duration_type_multi"><%= t('labels.duration.multiple_days') %></label>
        <div class="date-container multi-day-container">
          <%# Contenitore dei campi data - mostrato qui se è un evento multi-giorno %>
          <% if event.event_duration == 'multi-day' %>
            <div id="date-fields-container" class="date-range-fields" style="display: flex;">
              <div class="date-field">
                <label><%= t('labels.duration.from') %></label>
                <%= form.date_field :start_date, class: 'multi-day-start date-field', placeholder: 'Choose date...', 
                    data: { controller: 'datepicker' } %>
              </div>
              <div class="date-field">
                <label><%= t('labels.duration.to') %></label>
                <%= form.date_field :end_date, class: 'multi-day-end date-field', placeholder: 'Choose date...', 
                    data: { controller: 'datepicker' } %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div id="event-color" class="form-data-block">

    <div class="field color-picker">
      <%= form.label :color, t('labels.color') %>
      <%= form.color_field :color, value: event.color.present? ? event.color : "#00A3D7" %>
    </div>

  </div>

  <div class="actions">
    <%= form.submit event.new_record? ? t('actions.create_event') : t('actions.update_event'), class: 'button' %>
    oppure <%= link_to 'torna alla timeline', timeline_path(@timeline), class: 'back-link' %>
    <% unless event.new_record? %>
      | <%= link_to 'elimina evento', timeline_event_path(@timeline, event), 
                data: { 
                  turbo_method: :delete,
                  turbo_confirm: t('messages.confirm')
                },
                style: "color: red;" %>
    <% end %>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const multiDayStart = document.querySelector('.multi-day-start');
      const multiDayEnd = document.querySelector('.multi-day-end');
      const singleDayRadio = document.querySelector('#duration_type_single');
      const multiDayRadio = document.querySelector('#duration_type_multi');
      const dateFieldsContainer = document.querySelector('#date-fields-container');
      const singleDayContainer = document.querySelector('.single-day-container');
      const multiDayContainer = document.querySelector('.multi-day-container');

      function moveDateFields(targetContainer) {
        // Sposta i campi data nel contenitore appropriato
        if (dateFieldsContainer && dateFieldsContainer.parentElement !== targetContainer) {
          targetContainer.appendChild(dateFieldsContainer);
        }
      }

      function handleRadioChange() {
        if (singleDayRadio.checked) {
          moveDateFields(singleDayContainer);
        } else {
          moveDateFields(multiDayContainer);
        }
      }

      // Aggiungi event listener per i radio button
      singleDayRadio.addEventListener('change', handleRadioChange);
      multiDayRadio.addEventListener('change', handleRadioChange);
    });
  </script>
<% end %>
